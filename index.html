<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF工具箱完整版 - 网页版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        
        .container {
            max-width: 1400px; margin: 0 auto; background: white;
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white; padding: 30px; text-align: center;
        }
        
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: bold; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        
        .tabs {
            display: flex; background: #f5f5f5; border-bottom: 1px solid #ddd;
        }
        
        .tab {
            flex: 1; padding: 20px; text-align: center; cursor: pointer;
            font-weight: bold; font-size: 1.1em; transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover { background: #e8e8e8; }
        .tab.active { background: white; border-bottom-color: #2196F3; color: #2196F3; }
        
        .tab-content { display: none; padding: 40px; min-height: 600px; }
        .tab-content.active { display: block; }
        
        .info-box {
            background: #e8f5e8; border: 1px solid #4caf50; border-radius: 10px;
            padding: 20px; margin-bottom: 30px; color: #2e7d32;
        }
        
        .warning-box {
            background: #fff3e0; border: 1px solid #ff9800; border-radius: 10px;
            padding: 20px; margin-bottom: 30px; color: #e65100;
        }
        
        .upload-area {
            border: 3px dashed #2196F3; border-radius: 15px;
            padding: 40px; text-align: center; margin: 30px 0;
            transition: all 0.3s ease; cursor: pointer;
        }
        
        .upload-area:hover { border-color: #1976D2; background: #f3f9ff; }
        .upload-area.dragover { border-color: #4CAF50; background: #f1f8e9; }
        
        .upload-btn {
            background: #2196F3; color: white; border: none;
            padding: 15px 30px; border-radius: 25px;
            font-size: 1.1em; font-weight: bold; cursor: pointer;
            margin: 10px; transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            background: #1976D2; transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        
        .settings-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin: 30px 0;
        }
        
        .setting-card {
            background: #f8f9fa; border-radius: 12px; padding: 20px;
            border: 1px solid #e9ecef; transition: all 0.3s ease;
        }
        
        .setting-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .setting-title {
            font-size: 1.1em; font-weight: bold; margin-bottom: 15px;
            color: #333; display: flex; align-items: center; gap: 8px;
        }
        
        .setting-group { margin: 15px 0; }
        
        .setting-label {
            display: block; margin-bottom: 8px; font-weight: 500; color: #555;
        }
        
        .text-input, .select-input {
            width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 1em; transition: border-color 0.3s ease;
        }
        
        .text-input:focus, .select-input:focus {
            outline: none; border-color: #2196F3; box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .radio-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px; margin-top: 10px;
        }
        
        .radio-option {
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            padding: 8px 12px; border-radius: 6px; transition: background 0.3s ease;
        }
        
        .radio-option:hover { background: rgba(33, 150, 243, 0.1); }
        .radio-option input[type="radio"] { cursor: pointer; }
        
        .file-list {
            background: #f9f9f9; border-radius: 12px; padding: 20px;
            margin: 20px 0; max-height: 600px; overflow-y: auto;
        }
        
        .file-list h3 {
            margin-bottom: 15px; color: #333; display: flex;
            align-items: center; justify-content: space-between;
        }
        
        .file-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px; background: white; border-radius: 10px;
            margin: 10px 0; border-left: 4px solid #2196F3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease; cursor: move;
        }
        
        .file-item:hover { 
            box-shadow: 0 4px 16px rgba(0,0,0,0.15); 
            transform: translateY(-1px);
        }
        
        .file-item.dragging { opacity: 0.5; }
        
        .file-preview {
            width: 80px; height: 80px; flex-shrink: 0;
            border-radius: 8px; overflow: hidden;
            border: 2px solid #e0e0e0; background: #f5f5f5;
            display: flex; align-items: center; justify-content: center;
            cursor: zoom-in; position: relative;
        }
        
        .file-preview img {
            width: 100%; height: 100%; object-fit: cover;
        }
        
        .file-preview.loading {
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            animation: loading-animation 1s linear infinite;
        }
        
        @keyframes loading-animation {
            0% { background-position: 0 0, 0 10px, 10px -10px, -10px 0px; }
            100% { background-position: 20px 0, 20px 10px, 30px -10px, 10px 0px; }
        }
        
        .file-info { flex: 1; min-width: 0; }
        .file-name { 
            font-weight: 500; color: #333; margin-bottom: 4px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .file-size { color: #666; font-size: 0.9em; }
        
        .file-actions { display: flex; gap: 8px; flex-shrink: 0; }
        
        .action-btn {
            padding: 6px 12px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.9em; transition: all 0.3s ease;
            min-width: 35px;
        }
        
        .move-btn { background: #2196F3; color: white; }
        .move-btn:hover { background: #1976D2; }
        .move-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .remove-btn { background: #f44336; color: white; }
        .remove-btn:hover { background: #d32f2f; }
        
        .convert-btn {
            background: linear-gradient(135deg, #FF5722, #FF7043);
            color: white; border: none; padding: 20px 40px;
            border-radius: 30px; font-size: 1.3em; font-weight: bold;
            cursor: pointer; margin: 30px auto; display: block;
            transition: all 0.3s ease;
        }
        
        .convert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 87, 34, 0.4);
        }
        
        .convert-btn:disabled {
            background: #ccc; cursor: not-allowed; transform: none;
        }
        
        .progress-container { margin: 30px 0; display: none; }
        
        .progress-bar {
            background: #e0e0e0; border-radius: 12px; height: 30px;
            overflow: hidden; margin-bottom: 15px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            height: 100%; width: 0%; transition: width 0.3s ease;
            border-radius: 12px; display: flex; align-items: center;
            justify-content: center; color: white; font-weight: bold;
        }
        
        .progress-text {
            text-align: center; color: #666; font-weight: 500;
            margin-bottom: 10px;
        }
        
        .result-box {
            background: #e8f5e8; border: 2px solid #4caf50;
            border-radius: 12px; padding: 25px; margin: 20px 0;
            color: #2e7d32; display: none;
        }
        
        .error-box {
            background: #ffebee; border: 2px solid #f44336;
            border-radius: 12px; padding: 25px; margin: 20px 0;
            color: #c62828; display: none;
        }
        
        .slider {
            width: 100%; height: 6px; border-radius: 3px;
            background: #ddd; outline: none; margin: 10px 0;
        }
        
        .feature-badge {
            display: inline-block; background: #4CAF50; color: white;
            padding: 4px 8px; border-radius: 12px; font-size: 0.8em;
            margin-left: 8px;
        }

        /* 图片放大模态框 */
        .image-modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);
            align-items: center; justify-content: center;
        }
        
        .image-modal.active { display: flex; }
        
        .image-modal-content {
            max-width: 90%; max-height: 90%; object-fit: contain;
            border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .image-modal-close {
            position: absolute; top: 20px; right: 30px; color: #fff;
            font-size: 35px; font-weight: bold; cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .image-modal-close:hover { color: #ccc; }

        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 2em; }
            .tab-content { padding: 20px; }
            .settings-grid { grid-template-columns: 1fr; }
            .radio-grid { grid-template-columns: 1fr; }
            .file-actions { flex-direction: column; }
            .file-preview { width: 60px; height: 60px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>🔧 PDF工具箱完整版</h1>
            <p>图片转PDF增强版 & PDF解密 | 完全本地处理，保护您的隐私安全</p>
        </div>

        <!-- 选项卡导航 -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('img2pdf', this)">
                📷 图片转PDF <span class="feature-badge">增强版</span>
            </div>
            <div class="tab" onclick="switchTab('decrypt', this)">
                🔓 PDF解密 <span class="feature-badge">浏览器版</span>
            </div>
        </div>

        <!-- 图片转PDF选项卡 -->
        <div id="img2pdf" class="tab-content active">
            <div class="info-box">
                💡 <strong>增强功能：</strong> 支持多种合并方向、页面大小、图片排列方式、质量调节，可拖拽排序。现在支持图片预览和点击放大，让排序更直观！
            </div>

            <div class="upload-area" id="imageUploadArea">
                <input type="file" id="imageInput" multiple accept="image/*" style="display: none;">
                <h3>📁 选择图片文件</h3>
                <p>点击选择文件或拖拽图片到此处</p>
                <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                    选择图片文件
                </button>
            </div>

            <div class="settings-grid">
                <!-- 基本设置 -->
                <div class="setting-card">
                    <div class="setting-title">📝 基本设置</div>
                    
                    <div class="setting-group">
                        <label class="setting-label">输出文件名:</label>
                        <input type="text" id="outputPdfName" class="text-input" value="合并图片" placeholder="请输入PDF文件名">
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">排序方式:</label>
                        <div class="radio-grid">
                            <div class="radio-option">
                                <input type="radio" id="sortName" name="sortType" value="name" checked>
                                <label for="sortName">文件名</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="sortDate" name="sortType" value="date">
                                <label for="sortDate">修改时间</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="sortSize" name="sortType" value="size">
                                <label for="sortSize">文件大小</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 页面设置 -->
                <div class="setting-card">
                    <div class="setting-title">📄 页面设置</div>
                    
                    <div class="setting-group">
                        <label class="setting-label">页面大小:</label>
                        <select id="pageSize" class="select-input">
                            <option value="auto">自动适应图片大小</option>
                            <option value="A4">A4 (210×297mm)</option>
                            <option value="A3">A3 (297×420mm)</option>
                            <option value="A5">A5 (148×210mm)</option>
                            <option value="Letter">Letter (216×279mm)</option>
                            <option value="Legal">Legal (216×356mm)</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">页面方向:</label>
                        <div class="radio-grid">
                            <div class="radio-option">
                                <input type="radio" id="orientationPortrait" name="orientation" value="portrait" checked>
                                <label for="orientationPortrait">纵向</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="orientationLandscape" name="orientation" value="landscape">
                                <label for="orientationLandscape">横向</label>
                            </div>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">页边距 (mm):</label>
                        <input type="number" id="pageMargin" class="text-input" value="10" min="0" max="50">
                    </div>
                </div>

                <!-- 图片排列 -->
                <div class="setting-card">
                    <div class="setting-title">🖼️ 图片排列</div>
                    
                    <div class="setting-group">
                        <label class="setting-label">排列方式:</label>
                        <div class="radio-grid">
                            <div class="radio-option">
                                <input type="radio" id="layoutSingle" name="layout" value="single" checked>
                                <label for="layoutSingle">一页一图</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="layoutGrid2x1" name="layout" value="2x1">
                                <label for="layoutGrid2x1">2×1横向</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="layoutGrid1x2" name="layout" value="1x2">
                                <label for="layoutGrid1x2">1×2纵向</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="layoutGrid2x2" name="layout" value="2x2">
                                <label for="layoutGrid2x2">2×2网格</label>
                            </div>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">图片缩放:</label>
                        <div class="radio-grid">
                            <div class="radio-option">
                                <input type="radio" id="scaleFit" name="scale" value="fit" checked>
                                <label for="scaleFit">适应页面</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="scaleFill" name="scale" value="fill">
                                <label for="scaleFill">填充页面</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="scaleOriginal" name="scale" value="original">
                                <label for="scaleOriginal">原始大小</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 高级选项 -->
                <div class="setting-card">
                    <div class="setting-title">⚙️ 高级选项</div>
                    
                    <div class="setting-group">
                        <label class="setting-label">图片质量 (%):</label>
                        <input type="range" id="imageQuality" min="50" max="100" value="90" class="slider">
                        <div style="text-align: center; color: #666; margin-top: 5px;">
                            <span id="qualityValue">90%</span>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">背景颜色:</label>
                        <div class="radio-grid">
                            <div class="radio-option">
                                <input type="radio" id="bgWhite" name="background" value="white" checked>
                                <label for="bgWhite">白色</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="bgTransparent" name="background" value="transparent">
                                <label for="bgTransparent">透明</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="bgCustom" name="background" value="custom">
                                <label for="bgCustom">自定义</label>
                            </div>
                        </div>
                        <input type="color" id="customBgColor" value="#ffffff" style="margin-top: 10px; width: 100%; height: 40px; border: none; border-radius: 6px;">
                    </div>
                </div>
            </div>

            <div id="imageFileList" class="file-list" style="display: none;">
                <h3>
                    选中的图片文件：<span id="imageCount">(0个文件)</span>
                    <div style="font-size: 0.9em; font-weight: normal; color: #666;">
                        💡 拖拽文件可调整顺序，点击图片预览可放大查看
                    </div>
                </h3>
                <div id="imageFiles"></div>
            </div>

            <button id="convertImgBtn" class="convert-btn" onclick="convertImagesToPDF()" disabled>
                🔄 转换为PDF
            </button>

            <div id="imgProgress" class="progress-container">
                <div class="progress-text" id="imgProgressText">处理中...</div>
                <div class="progress-bar">
                    <div id="imgProgressFill" class="progress-fill">0%</div>
                </div>
            </div>

            <div id="imgResult" class="result-box"></div>
            <div id="imgError" class="error-box"></div>
        </div>

        <!-- PDF解密选项卡 -->
        <div id="decrypt" class="tab-content">
            <div class="info-box">
                💡 <strong>PDF解密功能：</strong> 完全在您的浏览器本地运行，文件和密码不会上传到任何服务器，最大限度保护您的隐私安全。请注意：此功能仅适用于已知密码的PDF文件。
            </div>

            <div class="upload-area" id="pdfUploadArea">
                <input type="file" id="pdfInput" accept="application/pdf" style="display: none;">
                <h3>📁 选择要解密的PDF文件</h3>
                <p>点击选择文件或拖拽PDF到此处</p>
                <button class="upload-btn" onclick="document.getElementById('pdfInput').click()">
                    选择PDF文件
                </button>
            </div>

            <div id="selectedPdfInfo" class="file-list" style="display: none;">
                <h3>选中的PDF文件：</h3>
                <div class="file-item">
                    <div class="file-preview">
                        📄
                    </div>
                    <div class="file-info">
                        <div class="file-name" id="selectedPdfName"></div>
                        <div class="file-size" id="selectedPdfSize"></div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn remove-btn" onclick="removePdfFile()">删除</button>
                    </div>
                </div>
            </div>

            <div class="setting-group" style="margin-top: 30px;">
                <label class="setting-label">输入PDF密码:</label>
                <input type="password" id="pdfPassword" class="text-input" placeholder="请输入PDF文档的打开密码">
            </div>

            <button id="decryptPdfBtn" class="convert-btn" onclick="decryptPdf()" disabled style="background: linear-gradient(135deg, #4CAF50, #8BC34A);">
                🔓 解密PDF
            </button>

            <div id="decryptProgress" class="progress-container">
                <div class="progress-text" id="decryptProgressText">解密中...</div>
                <div class="progress-bar">
                    <div id="decryptProgressFill" class="progress-fill">0%</div>
                </div>
            </div>

            <div id="decryptResult" class="result-box"></div>
            <div id="decryptError" class="error-box"></div>
        </div>
    </div>

    <!-- 图片放大模态框 -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close">&times;</span>
        <img class="image-modal-content" id="modalImage">
    </div>

    <script>
        // 全局变量
        let selectedImages = [];
        let selectedPdfFile = null;
        let draggedIndex = -1;

        // 选项卡切换
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            element.classList.add('active');
        }

        // 工具函数
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function naturalSort(a, b) {
            const re = /(\d+)|(\D+)/g;
            const A = String(a.name).match(re);
            const B = String(b.name).match(re);

            for (let i = 0; i < Math.min(A.length, B.length); i++) {
                const aPart = A[i];
                const bPart = B[i];
                const aIsNum = /^\d+$/.test(aPart);
                const bIsNum = /^\d+$/.test(bPart);

                if (aIsNum && bIsNum) {
                    const diff = parseInt(aPart) - parseInt(bPart);
                    if (diff !== 0) return diff;
                } else if (aPart !== bPart) {
                    return aPart.localeCompare(bPart);
                }
            }
            return A.length - B.length;
        }

        function mmToPt(mm) {
            return mm * 2.83464567;
        }

        // 创建图片预览
        function createImagePreview(file) {
            return new Promise((resolve) => {
                if (!file || !file.type.startsWith('image/')) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function() {
                    resolve(null);
                };
                reader.readAsDataURL(file);
            });
        }

        // 图片放大模态框
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.classList.add('active');
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
        }

        // ==================== 图片转PDF功能 ====================

        document.getElementById('imageInput').addEventListener('change', function(e) {
            handleImageFiles(Array.from(e.target.files));
        });

        const imageUploadArea = document.getElementById('imageUploadArea');
        imageUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            imageUploadArea.classList.add('dragover');
        });

        imageUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            imageUploadArea.classList.remove('dragover');
        });

        imageUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            imageUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleImageFiles(files);
        });

        function handleImageFiles(files) {
            const newFiles = files.filter(file => 
                !selectedImages.some(existing => existing.name === file.name && existing.size === file.size)
            );

            selectedImages = selectedImages.concat(newFiles);
            sortImages();
            updateImageFileList();
            document.getElementById('convertImgBtn').disabled = selectedImages.length === 0;
            
            if (selectedImages.length > 0 && document.getElementById('outputPdfName').value === "合并图片") {
                const firstFileName = selectedImages[0].name.split('.').slice(0, -1).join('.');
                document.getElementById('outputPdfName').value = `${firstFileName}_合并`;
            }
        }

        function sortImages() {
            const sortType = document.querySelector('input[name="sortType"]:checked').value;
            
            switch(sortType) {
                case 'name':
                    selectedImages.sort(naturalSort);
                    break;
                case 'date':
                    selectedImages.sort((a, b) => a.lastModified - b.lastModified);
                    break;
                case 'size':
                    selectedImages.sort((a, b) => a.size - b.size);
                    break;
            }
            
            updateImageFileList();
        }

        async function updateImageFileList() {
            const fileList = document.getElementById('imageFileList');
            const filesContainer = document.getElementById('imageFiles');
            const countSpan = document.getElementById('imageCount');
            
            if (selectedImages.length === 0) {
                fileList.style.display = 'none';
                return;
            }
            
            fileList.style.display = 'block';
            countSpan.textContent = `(${selectedImages.length}个文件)`;
            
            filesContainer.innerHTML = '';
            
            for (let index = 0; index < selectedImages.length; index++) {
                const file = selectedImages[index];
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.draggable = true;
                fileItem.dataset.index = index;
                
                const previewDiv = document.createElement('div');
                previewDiv.className = 'file-preview loading';
                previewDiv.innerHTML = '📷';
                
                // 拖拽事件
                fileItem.addEventListener('dragstart', function(e) {
                    draggedIndex = index;
                    this.classList.add('dragging');
                });
                
                fileItem.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                });
                
                fileItem.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                fileItem.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const dropIndex = parseInt(this.dataset.index);
                    if (draggedIndex !== dropIndex) {
                        const draggedFile = selectedImages[draggedIndex];
                        selectedImages.splice(draggedIndex, 1);
                        selectedImages.splice(dropIndex, 0, draggedFile);
                        updateImageFileList();
                    }
                });
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${index + 1}. ${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn move-btn" onclick="event.stopPropagation(); moveImage(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="action-btn move-btn" onclick="event.stopPropagation(); moveImage(${index}, 'down')" ${index === selectedImages.length - 1 ? 'disabled' : ''}>↓</button>
                        <button class="action-btn remove-btn" onclick="event.stopPropagation(); removeImage(${index})">删除</button>
                    </div>
                `;
                
                fileItem.insertBefore(previewDiv, fileItem.firstChild);
                filesContainer.appendChild(fileItem);
                
                // 异步加载图片预览
                createImagePreview(file).then(imageSrc => {
                    if (imageSrc && previewDiv.parentElement) {
                        previewDiv.classList.remove('loading');
                        const imgElement = document.createElement('img');
                        imgElement.src = imageSrc;
                        imgElement.alt = file.name;
                        previewDiv.innerHTML = '';
                        previewDiv.appendChild(imgElement);
                        
                        // 添加点击放大事件
                        previewDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openImageModal(imageSrc);
                        });
                    } else if (previewDiv.parentElement) {
                        previewDiv.classList.remove('loading');
                        previewDiv.innerHTML = '❌';
                        previewDiv.style.background = '#ffebee';
                        previewDiv.style.color = '#f44336';
                    }
                });
            }
        }

        function moveImage(index, direction) {
            if (direction === 'up' && index > 0) {
                [selectedImages[index], selectedImages[index - 1]] = [selectedImages[index - 1], selectedImages[index]];
            } else if (direction === 'down' && index < selectedImages.length - 1) {
                [selectedImages[index], selectedImages[index + 1]] = [selectedImages[index + 1], selectedImages[index]];
            }
            updateImageFileList();
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImageFileList();
            document.getElementById('convertImgBtn').disabled = selectedImages.length === 0;
        }

        document.querySelectorAll('input[name="sortType"]').forEach(radio => {
            radio.addEventListener('change', sortImages);
        });

        document.getElementById('imageQuality').addEventListener('input', function() {
            document.getElementById('qualityValue').textContent = this.value + '%';
        });

        async function convertImagesToPDF() {
            if (selectedImages.length === 0) return;

            const convertBtn = document.getElementById('convertImgBtn');
            const progressContainer = document.getElementById('imgProgress');
            const progressFill = document.getElementById('imgProgressFill');
            const progressText = document.getElementById('imgProgressText');
            const resultBox = document.getElementById('imgResult');
            const errorBox = document.getElementById('imgError');

            resultBox.style.display = 'none';
            errorBox.style.display = 'none';

            convertBtn.disabled = true;
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';

            try {
                const settings = {
                    pageSize: document.getElementById('pageSize').value,
                    orientation: document.querySelector('input[name="orientation"]:checked').value,
                    layout: document.querySelector('input[name="layout"]:checked').value,
                    scale: document.querySelector('input[name="scale"]:checked').value,
                    quality: parseInt(document.getElementById('imageQuality').value) / 100,
                    margin: mmToPt(parseInt(document.getElementById('pageMargin').value)),
                    background: document.querySelector('input[name="background"]:checked').value,
                    customBgColor: document.getElementById('customBgColor').value
                };

                const { PDFDocument, rgb } = PDFLib;
                const pdfDoc = await PDFDocument.create();
                
                let pageWidth, pageHeight;
                const pageSizes = {
                    'A4': [595, 842],
                    'A3': [842, 1191],
                    'A5': [420, 595],
                    'Letter': [612, 792],
                    'Legal': [612, 1008]
                };

                if (settings.pageSize === 'auto') {
                    const firstImage = selectedImages[0];
                    const img = new Image();
                    await new Promise(resolve => {
                        img.onload = resolve;
                        img.src = URL.createObjectURL(firstImage);
                    });
                    pageWidth = img.width;
                    pageHeight = img.height;
                    URL.revokeObjectURL(img.src);
                } else {
                    [pageWidth, pageHeight] = pageSizes[settings.pageSize];
                }

                if (settings.orientation === 'landscape') {
                    [pageWidth, pageHeight] = [pageHeight, pageWidth];
                }

                const layoutConfig = {
                    'single': { cols: 1, rows: 1 },
                    '2x1': { cols: 2, rows: 1 },
                    '1x2': { cols: 1, rows: 2 },
                    '2x2': { cols: 2, rows: 2 }
                };
                
                const { cols, rows } = layoutConfig[settings.layout];
                const imagesPerPage = cols * rows;
                
                for (let i = 0; i < selectedImages.length; i += imagesPerPage) {
                    const progress = Math.round(((i + imagesPerPage) / selectedImages.length) * 100);
                    progressText.textContent = `处理图片 ${i + 1}-${Math.min(i + imagesPerPage, selectedImages.length)}/${selectedImages.length}`;
                    progressFill.style.width = `${Math.min(progress, 100)}%`;
                    progressFill.textContent = `${Math.min(progress, 100)}%`;
                    
                    const page = pdfDoc.addPage([pageWidth, pageHeight]);
                    
                    if (settings.background !== 'transparent') {
                        let bgColor;
                        if (settings.background === 'white') {
                            bgColor = rgb(1, 1, 1);
                        } else {
                            const hex = settings.customBgColor;
                            const r = parseInt(hex.substr(1, 2), 16) / 255;
                            const g = parseInt(hex.substr(3, 2), 16) / 255;
                            const b = parseInt(hex.substr(5, 2), 16) / 255;
                            bgColor = rgb(r, g, b);
                        }
                        page.drawRectangle({
                            x: 0, y: 0,
                            width: pageWidth, height: pageHeight,
                            color: bgColor
                        });
                    }
                    
                    const pageImages = selectedImages.slice(i, i + imagesPerPage);
                    await processImagesOnPage(pdfDoc, page, pageImages, settings, pageWidth, pageHeight, cols, rows);
                    
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
                
                progressText.textContent = '生成PDF文件...';
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                
                const pdfBytes = await pdfDoc.save();
                
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                let outputFileName = document.getElementById('outputPdfName').value.trim();
                if (!outputFileName) {
                    outputFileName = `合并图片_${selectedImages.length}张`;
                }
                a.href = url;
                a.download = `${outputFileName}.pdf`;
                a.click();
                URL.revokeObjectURL(url);
                
                resultBox.innerHTML = `
                    <h3>✅ 转换成功！</h3>
                    <p>已成功将 <strong>${selectedImages.length}</strong> 张图片转换为PDF文件</p>
                    <p><strong>设置详情：</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>页面大小：${settings.pageSize === 'auto' ? '自动适应' : settings.pageSize}</li>
                        <li>页面方向：${settings.orientation === 'portrait' ? '纵向' : '横向'}</li>
                        <li>排列方式：${settings.layout}</li>
                        <li>图片质量：${Math.round(settings.quality * 100)}%</li>
                    </ul>
                    <p>文件已开始下载，请查看浏览器下载文件夹</p>
                    <p>PDF大小：约 ${formatFileSize(pdfBytes.length)}</p>
                `;
                resultBox.style.display = 'block';
                
                selectedImages = [];
                updateImageFileList();
                
            } catch (error) {
                console.error('转换失败:', error);
                errorBox.innerHTML = `
                    <h3>❌ 转换失败</h3>
                    <p>错误信息：${error.message}</p>
                    <p>请检查图片文件是否有损坏，或尝试调整设置后重试</p>
                `;
                errorBox.style.display = 'block';
            } finally {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    convertBtn.disabled = false;
                }, 2000);
            }
        }

        async function processImagesOnPage(pdfDoc, page, images, settings, pageWidth, pageHeight, cols, rows) {
            const availableWidth = pageWidth - 2 * settings.margin;
            const availableHeight = pageHeight - 2 * settings.margin;
            const cellWidth = availableWidth / cols;
            const cellHeight = availableHeight / rows;
            
            for (let i = 0; i < images.length; i++) {
                const image = images[i];
                const pdfImage = await embedImageInPDF(pdfDoc, image, settings.quality);
                
                const col = i % cols;
                const row = Math.floor(i / cols);
                const x = settings.margin + col * cellWidth;
                const y = pageHeight - settings.margin - (row + 1) * cellHeight;
                
                drawImageInCell(page, pdfImage, x, y, cellWidth, cellHeight, settings.scale);
            }
        }

        async function embedImageInPDF(pdfDoc, file, quality) {
            const imageBytes = await file.arrayBuffer();
            
            if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
                return await pdfDoc.embedJpg(imageBytes);
            } else if (file.type === 'image/png') {
                return await pdfDoc.embedPng(imageBytes);
            } else {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                await new Promise(resolve => {
                    img.onload = resolve;
                    img.src = URL.createObjectURL(file);
                });
                
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const jpegDataUrl = canvas.toDataURL('image/jpeg', quality);
                const jpegBytes = await fetch(jpegDataUrl).then(res => res.arrayBuffer());
                
                URL.revokeObjectURL(img.src);
                return await pdfDoc.embedJpg(jpegBytes);
            }
        }

        function drawImageInCell(page, pdfImage, x, y, cellWidth, cellHeight, scaleMode) {
            const imageAspect = pdfImage.width / pdfImage.height;
            const cellAspect = cellWidth / cellHeight;
            
            let width, height, offsetX = 0, offsetY = 0;
            
            if (scaleMode === 'fit') {
                if (imageAspect > cellAspect) {
                    width = cellWidth;
                    height = cellWidth / imageAspect;
                    offsetY = (cellHeight - height) / 2;
                } else {
                    height = cellHeight;
                    width = cellHeight * imageAspect;
                    offsetX = (cellWidth - width) / 2;
                }
            } else if (scaleMode === 'fill') {
                if (imageAspect > cellAspect) {
                    height = cellHeight;
                    width = cellHeight * imageAspect;
                    offsetX = (cellWidth - width) / 2;
                } else {
                    width = cellWidth;
                    height = cellWidth / imageAspect;
                    offsetY = (cellHeight - height) / 2;
                }
            } else {
                width = Math.min(pdfImage.width, cellWidth);
                height = Math.min(pdfImage.height, cellHeight);
                offsetX = (cellWidth - width) / 2;
                offsetY = (cellHeight - height) / 2;
            }
            
            page.drawImage(pdfImage, { 
                x: x + offsetX, 
                y: y + offsetY, 
                width, 
                height 
            });
        }

        // ==================== PDF解密功能 ====================

        const pdfUploadArea = document.getElementById('pdfUploadArea');
        const pdfInput = document.getElementById('pdfInput');

        pdfInput.addEventListener('change', function(e) {
            handlePdfFile(e.target.files[0]);
        });

        pdfUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            pdfUploadArea.classList.add('dragover');
        });

        pdfUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            pdfUploadArea.classList.remove('dragover');
        });

        pdfUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            pdfUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            if (files.length > 0) {
                handlePdfFile(files[0]);
            }
        });

        function handlePdfFile(file) {
            if (!file || file.type !== 'application/pdf') {
                alert('请选择一个PDF文件。');
                return;
            }
            selectedPdfFile = file;
            document.getElementById('selectedPdfName').textContent = file.name;
            document.getElementById('selectedPdfSize').textContent = formatFileSize(file.size);
            document.getElementById('selectedPdfInfo').style.display = 'block';
            document.getElementById('decryptPdfBtn').disabled = false;
            
            document.getElementById('decryptResult').style.display = 'none';
            document.getElementById('decryptError').style.display = 'none';
        }

        function removePdfFile() {
            selectedPdfFile = null;
            document.getElementById('selectedPdfInfo').style.display = 'none';
            document.getElementById('pdfInput').value = '';
            document.getElementById('decryptPdfBtn').disabled = true;
            document.getElementById('pdfPassword').value = '';
        }

        async function decryptPdf() {
            if (!selectedPdfFile) {
                alert('请先选择一个PDF文件。');
                return;
            }

            const password = document.getElementById('pdfPassword').value;
            if (!password) {
                alert('请输入PDF密码。');
                return;
            }

            const decryptBtn = document.getElementById('decryptPdfBtn');
            const progressContainer = document.getElementById('decryptProgress');
            const progressFill = document.getElementById('decryptProgressFill');
            const progressText = document.getElementById('decryptProgressText');
            const resultBox = document.getElementById('decryptResult');
            const errorBox = document.getElementById('decryptError');

            decryptBtn.disabled = true;
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';
            progressText.textContent = '正在读取文件...';
            
            resultBox.style.display = 'none';
            errorBox.style.display = 'none';

            try {
                const arrayBuffer = await selectedPdfFile.arrayBuffer();
                progressText.textContent = '正在解密PDF...';
                progressFill.style.width = '50%';
                progressFill.textContent = '50%';

                const { PDFDocument } = PDFLib;
                let pdfDoc;
                try {
                    pdfDoc = await PDFDocument.load(arrayBuffer, { password: password });
                } catch (e) {
                    if (e.message.includes('Incorrect password') || e.message.includes('password')) {
                        throw new Error('密码不正确，请重新输入。');
                    } else if (e.message.includes('not encrypted')) {
                        throw new Error('此PDF文件未加密，无需解密。');
                    }
                    throw e;
                }
                
                progressText.textContent = '正在生成无密码PDF...';
                progressFill.style.width = '80%';
                progressFill.textContent = '80%';

                const decryptedPdfBytes = await pdfDoc.save();

                progressText.textContent = '解密成功，正在下载...';
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';

                const blob = new Blob([decryptedPdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const originalFileName = selectedPdfFile.name.split('.').slice(0, -1).join('.');
                a.download = `${originalFileName}_解密.pdf`;
                a.click();
                URL.revokeObjectURL(url);

                resultBox.innerHTML = `
                    <h3>✅ 解密成功！</h3>
                    <p>文件 <strong>${selectedPdfFile.name}</strong> 已成功解密并下载。</p>
                    <p>新的PDF文件不包含密码保护，大小约 ${formatFileSize(decryptedPdfBytes.length)}。</p>
                    <p>解密后的文件保持了原始的文本层和格式。</p>
                `;
                resultBox.style.display = 'block';

                removePdfFile();

            } catch (error) {
                console.error('PDF解密失败:', error);
                errorBox.innerHTML = `
                    <h3>❌ 解密失败</h3>
                    <p>错误信息：${error.message}</p>
                    <p>请确认密码是否正确，或检查文件是否损坏。</p>
                `;
                errorBox.style.display = 'block';
            } finally {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    decryptBtn.disabled = selectedPdfFile === null;
                }, 2000);
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('imageQuality').dispatchEvent(new Event('input'));
            
            // 为模态框关闭按钮添加事件
            document.querySelector('.image-modal-close').addEventListener('click', function(e) {
                e.stopPropagation();
                closeImageModal();
            });
        });
    </script>
</body>
</html>
